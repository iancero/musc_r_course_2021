<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Multilevel Models | An Organic R Textbook</title>
  <meta name="description" content="This is the organic textbook accompanying Cero’s 2021 course on statistical programming with R" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Multilevel Models | An Organic R Textbook" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://iancero.github.io/musc_r_course_2021" />
  
  <meta property="og:description" content="This is the organic textbook accompanying Cero’s 2021 course on statistical programming with R" />
  <meta name="github-repo" content="iancero/musc_r_course_2021" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Multilevel Models | An Organic R Textbook" />
  
  <meta name="twitter:description" content="This is the organic textbook accompanying Cero’s 2021 course on statistical programming with R" />
  

<meta name="author" content="Ian Cero, PhD MStat" />


<meta name="date" content="2021-01-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="basic-r.html"/>

<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a></li>
<li class="chapter" data-level="2" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>2</b> Getting Started</a>
<ul>
<li class="chapter" data-level="2.1" data-path="getting-started.html"><a href="getting-started.html#overview-of-the-r-ecosystem"><i class="fa fa-check"></i><b>2.1</b> Overview of the R ecosystem</a></li>
<li class="chapter" data-level="2.2" data-path="getting-started.html"><a href="getting-started.html#installation"><i class="fa fa-check"></i><b>2.2</b> Installation</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="getting-started.html"><a href="getting-started.html#step-1---download-and-install-the-r-language"><i class="fa fa-check"></i><b>2.2.1</b> Step 1 - Download and install the R language</a></li>
<li class="chapter" data-level="2.2.2" data-path="getting-started.html"><a href="getting-started.html#step-2---download-and-install-the-rstudio-ide"><i class="fa fa-check"></i><b>2.2.2</b> Step 2 - Download and install the RStudio IDE</a></li>
<li class="chapter" data-level="2.2.3" data-path="getting-started.html"><a href="getting-started.html#step-3---install-the-tidyverse-package-optional"><i class="fa fa-check"></i><b>2.2.3</b> Step 3 - Install the <code>tidyverse</code> package (optional)</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="getting-started.html"><a href="getting-started.html#a-tour-of-rstudio"><i class="fa fa-check"></i><b>2.3</b> A tour of RStudio</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="getting-started.html"><a href="getting-started.html#the-console"><i class="fa fa-check"></i><b>2.3.1</b> The console</a></li>
<li class="chapter" data-level="2.3.2" data-path="getting-started.html"><a href="getting-started.html#the-environment"><i class="fa fa-check"></i><b>2.3.2</b> The environment</a></li>
<li class="chapter" data-level="2.3.3" data-path="getting-started.html"><a href="getting-started.html#the-lower-right-pane"><i class="fa fa-check"></i><b>2.3.3</b> The lower right pane</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="getting-started.html"><a href="getting-started.html#your-very-first-analysis"><i class="fa fa-check"></i><b>2.4</b> Your very first analysis</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="getting-started.html"><a href="getting-started.html#step-1---download-the-data"><i class="fa fa-check"></i><b>2.4.1</b> Step 1 - download the data</a></li>
<li class="chapter" data-level="2.4.2" data-path="getting-started.html"><a href="getting-started.html#step-2---make-an-rstudio-project"><i class="fa fa-check"></i><b>2.4.2</b> Step 2 - Make an RStudio Project</a></li>
<li class="chapter" data-level="2.4.3" data-path="getting-started.html"><a href="getting-started.html#step-3---get-the-data-into-your-project-folder"><i class="fa fa-check"></i><b>2.4.3</b> Step 3 - Get the data into your project folder</a></li>
<li class="chapter" data-level="2.4.4" data-path="getting-started.html"><a href="getting-started.html#step-4---open-an-rmarkdown-notebook"><i class="fa fa-check"></i><b>2.4.4</b> Step 4 - Open an Rmarkdown Notebook</a></li>
<li class="chapter" data-level="2.4.5" data-path="getting-started.html"><a href="getting-started.html#step-5---create-a-space-to-code"><i class="fa fa-check"></i><b>2.4.5</b> Step 5 - Create a space to code</a></li>
<li class="chapter" data-level="2.4.6" data-path="getting-started.html"><a href="getting-started.html#step-6---write-a-command-to-import-the-data"><i class="fa fa-check"></i><b>2.4.6</b> Step 6 - Write a command to import the data</a></li>
<li class="chapter" data-level="2.4.7" data-path="getting-started.html"><a href="getting-started.html#step-7---look-inside-the-data"><i class="fa fa-check"></i><b>2.4.7</b> Step 7 - Look inside the data</a></li>
<li class="chapter" data-level="2.4.8" data-path="getting-started.html"><a href="getting-started.html#step-8---make-a-histogram"><i class="fa fa-check"></i><b>2.4.8</b> Step 8 - Make a histogram</a></li>
<li class="chapter" data-level="2.4.9" data-path="getting-started.html"><a href="getting-started.html#step-9---run-a-regression"><i class="fa fa-check"></i><b>2.4.9</b> Step 9 - Run a regression</a></li>
<li class="chapter" data-level="2.4.10" data-path="getting-started.html"><a href="getting-started.html#step-10---get-a-summary-of-your-results"><i class="fa fa-check"></i><b>2.4.10</b> Step 10 - Get a summary of your results</a></li>
<li class="chapter" data-level="2.4.11" data-path="getting-started.html"><a href="getting-started.html#a-look-forward"><i class="fa fa-check"></i><b>2.4.11</b> A Look forward</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="basic-r.html"><a href="basic-r.html"><i class="fa fa-check"></i><b>3</b> Basic R</a>
<ul>
<li class="chapter" data-level="3.1" data-path="basic-r.html"><a href="basic-r.html#writing-in-r-and-rmarkdown"><i class="fa fa-check"></i><b>3.1</b> Writing in R and Rmarkdown</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="basic-r.html"><a href="basic-r.html#chatting-with-r"><i class="fa fa-check"></i><b>3.1.1</b> Chatting with R</a></li>
<li class="chapter" data-level="3.1.2" data-path="basic-r.html"><a href="basic-r.html#rmarkdown-tricks"><i class="fa fa-check"></i><b>3.1.2</b> Rmarkdown tricks</a></li>
<li class="chapter" data-level="3.1.3" data-path="basic-r.html"><a href="basic-r.html#code-blocks"><i class="fa fa-check"></i><b>3.1.3</b> Code blocks</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="basic-r.html"><a href="basic-r.html#variables"><i class="fa fa-check"></i><b>3.2</b> Variables</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="basic-r.html"><a href="basic-r.html#the-assignment-operator"><i class="fa fa-check"></i><b>3.2.1</b> The assignment operator</a></li>
<li class="chapter" data-level="3.2.2" data-path="basic-r.html"><a href="basic-r.html#numerics"><i class="fa fa-check"></i><b>3.2.2</b> Numerics</a></li>
<li class="chapter" data-level="3.2.3" data-path="basic-r.html"><a href="basic-r.html#characters"><i class="fa fa-check"></i><b>3.2.3</b> Characters</a></li>
<li class="chapter" data-level="3.2.4" data-path="basic-r.html"><a href="basic-r.html#booleans"><i class="fa fa-check"></i><b>3.2.4</b> Booleans</a></li>
<li class="chapter" data-level="3.2.5" data-path="basic-r.html"><a href="basic-r.html#special-types"><i class="fa fa-check"></i><b>3.2.5</b> Special types</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="basic-r.html"><a href="basic-r.html#vectors"><i class="fa fa-check"></i><b>3.3</b> Vectors</a></li>
<li class="chapter" data-level="3.4" data-path="basic-r.html"><a href="basic-r.html#lists"><i class="fa fa-check"></i><b>3.4</b> Lists</a></li>
<li class="chapter" data-level="3.5" data-path="basic-r.html"><a href="basic-r.html#dataframes"><i class="fa fa-check"></i><b>3.5</b> Dataframes</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="basic-r.html"><a href="basic-r.html#construction"><i class="fa fa-check"></i><b>3.5.1</b> Construction</a></li>
<li class="chapter" data-level="3.5.2" data-path="basic-r.html"><a href="basic-r.html#built-in-dataframes"><i class="fa fa-check"></i><b>3.5.2</b> Built-in dataframes</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="basic-r.html"><a href="basic-r.html#functions"><i class="fa fa-check"></i><b>3.6</b> Functions</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="basic-r.html"><a href="basic-r.html#getting-help"><i class="fa fa-check"></i><b>3.6.1</b> Getting help</a></li>
<li class="chapter" data-level="3.6.2" data-path="basic-r.html"><a href="basic-r.html#function-parameters"><i class="fa fa-check"></i><b>3.6.2</b> Function parameters</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="basic-r.html"><a href="basic-r.html#packages"><i class="fa fa-check"></i><b>3.7</b> Packages</a></li>
<li class="chapter" data-level="3.8" data-path="basic-r.html"><a href="basic-r.html#error-messages"><i class="fa fa-check"></i><b>3.8</b> Error messages</a></li>
<li class="chapter" data-level="3.9" data-path="basic-r.html"><a href="basic-r.html#coding-conventions"><i class="fa fa-check"></i><b>3.9</b> Coding Conventions</a>
<ul>
<li class="chapter" data-level="3.9.1" data-path="basic-r.html"><a href="basic-r.html#what-should-my-code-look-like"><i class="fa fa-check"></i><b>3.9.1</b> What should my code look like?</a></li>
<li class="chapter" data-level="3.9.2" data-path="basic-r.html"><a href="basic-r.html#official-coding-conventions"><i class="fa fa-check"></i><b>3.9.2</b> Official coding conventions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="multilevel-models.html"><a href="multilevel-models.html"><i class="fa fa-check"></i><b>4</b> Multilevel Models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="multilevel-models.html"><a href="multilevel-models.html#steps-1-2---import-and-clean-the-data"><i class="fa fa-check"></i><b>4.1</b> Steps 1 &amp; 2 - Import and clean the data</a></li>
<li class="chapter" data-level="4.2" data-path="multilevel-models.html"><a href="multilevel-models.html#steps-3-4---fit-the-model-and-summarize-it"><i class="fa fa-check"></i><b>4.2</b> Steps 3 &amp; 4 - Fit the model and summarize it</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="multilevel-models.html"><a href="multilevel-models.html#where-are-my-p-values"><i class="fa fa-check"></i><b>4.2.1</b> Where are my p-values?</a></li>
<li class="chapter" data-level="4.2.2" data-path="multilevel-models.html"><a href="multilevel-models.html#where-are-my-intraclass-correlations-iccs"><i class="fa fa-check"></i><b>4.2.2</b> Where are my intraclass correlations (ICCs)?</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="multilevel-models.html"><a href="multilevel-models.html#logistic-multilevel-models"><i class="fa fa-check"></i><b>4.3</b> Logistic multilevel models</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">An Organic R Textbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="multilevel-models" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Multilevel Models</h1>
<p>In a multilevel model, we try to account not only for group-level variation, but individual variation as well. As a reminder, the way that we do this is by proposing:</p>
<ol style="list-style-type: decimal">
<li><p>There is an overall slope and intercept for our regression model, just like in a traditional linear regression.</p></li>
<li><p>But, there might be some variation from person to person or day to day in the value of that <strong>slope</strong>, <strong>intercept</strong>, or <strong>both</strong>.</p>
<ul>
<li>You can think of this like it being generally true that sleep loss leads to decreased mood the next day, but for some people it is worse than others (<strong>variable slopes</strong>).</li>
<li>Alternatively, you might think the damage done by sleep loss is roughly the same from person to person - or perhaps that an intervention is roughly as effective for all people - but that different people start with varying degrees of sleep lost (<strong>variable intercepts</strong>).</li>
<li>Lastly, you might think <strong>both</strong>.</li>
</ul></li>
</ol>
<p>The trick to remember is that we are just specifying a traditional regression, <em>plus</em> allowing some of its parameters to be slightly different from person to person.</p>
<div id="steps-1-2---import-and-clean-the-data" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Steps 1 &amp; 2 - Import and clean the data</h2>
<p>Again to maximize comparability with previous chapters on regression techniques, we’ll use the same KSADS ABCD dataset.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="multilevel-models.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="multilevel-models.html#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="multilevel-models.html#cb1-3" aria-hidden="true" tabindex="-1"></a>read_abcd_quietly <span class="ot">&lt;-</span> <span class="cf">function</span>(file_path){</span>
<span id="cb1-4"><a href="multilevel-models.html#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>(</span>
<span id="cb1-5"><a href="multilevel-models.html#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">expr =</span> <span class="fu">read_delim</span>(file_path, <span class="at">delim =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-6"><a href="multilevel-models.html#cb1-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-7"><a href="multilevel-models.html#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">type_convert</span>())</span>
<span id="cb1-8"><a href="multilevel-models.html#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-9"><a href="multilevel-models.html#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="multilevel-models.html#cb1-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_abcd_quietly</span>(<span class="st">&#39;data/abcd_lpksad01.txt&#39;</span>)</span></code></pre></div>
<p>But along the way, it is important to note that this is a <strong>longitudinal</strong> dataset with many participants providing multiple data points to us. You can thus think of those data points as providing multiple pieces of information for each person, which we can use to estimate (for example) their own personal intercept in a multilevel model.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="multilevel-models.html#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="multilevel-models.html#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb2-3"><a href="multilevel-models.html#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> src_subject_id, </span>
<span id="cb2-4"><a href="multilevel-models.html#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> interview_age,</span>
<span id="cb2-5"><a href="multilevel-models.html#cb2-5" aria-hidden="true" tabindex="-1"></a>    sex, </span>
<span id="cb2-6"><a href="multilevel-models.html#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">grade_drop =</span> kbi_p_c_drop_in_grades_l,</span>
<span id="cb2-7"><a href="multilevel-models.html#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">grades =</span> kbi_p_grades_in_school_l) <span class="sc">%&gt;%</span> </span>
<span id="cb2-8"><a href="multilevel-models.html#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb2-9"><a href="multilevel-models.html#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(age) <span class="sc">%&gt;%</span> </span>
<span id="cb2-10"><a href="multilevel-models.html#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-11"><a href="multilevel-models.html#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">floor</span>(age <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb2-12"><a href="multilevel-models.html#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> <span class="fu">factor</span>(sex, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;M&#39;</span>, <span class="st">&#39;F&#39;</span>)),</span>
<span id="cb2-13"><a href="multilevel-models.html#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2-14"><a href="multilevel-models.html#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_timepoints =</span> <span class="fu">max</span>(time),</span>
<span id="cb2-15"><a href="multilevel-models.html#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">grade_drop =</span> <span class="fu">factor</span>(grade_drop, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;yes&#39;</span>, <span class="st">&#39;no&#39;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb2-16"><a href="multilevel-models.html#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-17"><a href="multilevel-models.html#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(grades <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-18"><a href="multilevel-models.html#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, age, sex, grades, grade_drop, time)</span></code></pre></div>
</div>
<div id="steps-3-4---fit-the-model-and-summarize-it" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Steps 3 &amp; 4 - Fit the model and summarize it</h2>
<p>As we saw with logistic regression, R’s regression-centric statistical framework makes transition to a new type of regression easy for us to think about: almost everything is the same, we just need to tweak a few specifics.</p>
<p>The first thing to note is that we’ll need to load the <code>lme4</code> package, which contains a function to fit a multilevel model. Next, we use the <code>lmer()</code> function to fit the model, rather than the traditional <code>lm()</code> for a classic linear regression.</p>
<p>After that, the last obvious change we need to make is that we need to tell R which parameters we want to vary and what our nesting structure is. Fortunately, that is pretty easy too. We just add it to our regression formula like this <code>+ (params_to_vary | vary_by_what)</code>.</p>
<p>As you can see below, the randomly varying part of our model is specified as <code>(1 | id)</code>. Because <code>1</code> is R’s indicator for an intercept and <code>id</code> is our dataset’s variable indicating which person we are talking about (remember each ID will have multiple timepoints), this specification will produce a regression where the slope stays constant for everyone, BUT everyone has their own special intercept (i.e. a random intercept only model).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="multilevel-models.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb3-2"><a href="multilevel-models.html#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="multilevel-models.html#cb3-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb3-4"><a href="multilevel-models.html#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> grades <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id),</span>
<span id="cb3-5"><a href="multilevel-models.html#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df)</span>
<span id="cb3-6"><a href="multilevel-models.html#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="multilevel-models.html#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [&#39;lmerModLmerTest&#39;]
## Formula: grades ~ age + sex + (1 | id)
##    Data: df
## 
## REML criterion at convergence: 50990.9
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.3199 -0.3357 -0.1901  0.2137  5.2364 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  id       (Intercept) 0.4181   0.6466  
##  Residual             0.2304   0.4800  
## Number of obs: 24771, groups:  id, 10301
## 
## Fixed effects:
##               Estimate Std. Error         df t value Pr(&gt;|t|)    
## (Intercept)  1.654e+00  4.460e-02  2.018e+04  37.089  &lt; 2e-16 ***
## age          1.121e-02  3.846e-03  1.888e+04   2.915  0.00357 ** 
## sexF        -2.006e-01  1.424e-02  1.013e+04 -14.088  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##      (Intr) age   
## age  -0.975       
## sexF -0.160  0.008</code></pre>
<p>As you can see, the output is again quite similar to the regular <code>lm()</code> output. However, there are two twists.</p>
<ol style="list-style-type: decimal">
<li>Because we have a random intercept, the intercept now has a group-level mean (under Fixed Effects) AND it has its own variance (under Random Effects).</li>
<li>We’re missing p-values! Find out how to get those below.</li>
</ol>
<div id="where-are-my-p-values" class="section level3" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Where are my p-values?</h3>
<p>Multilevel models are mathematically complicated, under the hood. For reasons we wont go into here, there are many ways to compute their p-values and the <code>lme4</code> package doesn’t want to make the choice for you out of an abundance of caution.</p>
<p>To get our p-values, we can use the <code>lmerTest</code> package, which will override the <code>lmer()</code> function to include p-values. Thus, if we run our same model again, but with <code>lmerTest</code> loaded we should get what we expected.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="multilevel-models.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb5-2"><a href="multilevel-models.html#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="multilevel-models.html#cb5-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb5-4"><a href="multilevel-models.html#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> grades <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id),</span>
<span id="cb5-5"><a href="multilevel-models.html#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df)</span>
<span id="cb5-6"><a href="multilevel-models.html#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="multilevel-models.html#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [&#39;lmerModLmerTest&#39;]
## Formula: grades ~ age + sex + (1 | id)
##    Data: df
## 
## REML criterion at convergence: 50990.9
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.3199 -0.3357 -0.1901  0.2137  5.2364 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  id       (Intercept) 0.4181   0.6466  
##  Residual             0.2304   0.4800  
## Number of obs: 24771, groups:  id, 10301
## 
## Fixed effects:
##               Estimate Std. Error         df t value Pr(&gt;|t|)    
## (Intercept)  1.654e+00  4.460e-02  2.018e+04  37.089  &lt; 2e-16 ***
## age          1.121e-02  3.846e-03  1.888e+04   2.915  0.00357 ** 
## sexF        -2.006e-01  1.424e-02  1.013e+04 -14.088  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##      (Intr) age   
## age  -0.975       
## sexF -0.160  0.008</code></pre>
</div>
<div id="where-are-my-intraclass-correlations-iccs" class="section level3" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Where are my intraclass correlations (ICCs)?</h3>
<p>One measure of the strength of variation for a random effect in a multilevel model is the Intraclass Correlation Coefficient (ICC). These tell you the percentage of variation in the your estimate can be attributed to random variation from person to person.</p>
<p>Unfortunately, <code>lmer()</code> doesn’t compute this on its own, so we need to ask the <code>performance</code> package to do it for us.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="multilevel-models.html#cb7-1" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">icc</span>(fit)</span></code></pre></div>
<pre><code>## # Intraclass Correlation Coefficient
## 
##      Adjusted ICC: 0.645
##   Conditional ICC: 0.635</code></pre>
</div>
</div>
<div id="logistic-multilevel-models" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Logistic multilevel models</h2>
<p>So far, we’ve fit just linear multilevel models, but note that the transition to a logistic version is the same as the transition from a traditional linear model to a traditional logistic one:</p>
<ul>
<li><code>lm()</code> becomes <code>glm()</code>; <code>lmer()</code> becomes <code>glmer()</code></li>
<li>We need to specify the family of non-linear model we are using, which is again “binomial”</li>
</ul>
<p>Then everything else is the same.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="multilevel-models.html#cb9-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glmer</span>(</span>
<span id="cb9-2"><a href="multilevel-models.html#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> grade_drop <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id),</span>
<span id="cb9-3"><a href="multilevel-models.html#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df,</span>
<span id="cb9-4"><a href="multilevel-models.html#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>)</span>
<span id="cb9-5"><a href="multilevel-models.html#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="multilevel-models.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code></pre></div>
<pre><code>## Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [
## glmerMod]
##  Family: binomial  ( logit )
## Formula: grade_drop ~ age + sex + (1 | id)
##    Data: df
## 
##      AIC      BIC   logLik deviance df.resid 
##  20086.6  20119.0 -10039.3  20078.6    24440 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.0384  0.2134  0.2559  0.3115  1.0890 
## 
## Random effects:
##  Groups Name        Variance Std.Dev.
##  id     (Intercept) 2.064    1.437   
## Number of obs: 24444, groups:  id, 10275
## 
## Fixed effects:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  5.87861    0.26782  21.950   &lt;2e-16 ***
## age         -0.33012    0.02241 -14.728   &lt;2e-16 ***
## sexF         0.46215    0.05188   8.908   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##      (Intr) age   
## age  -0.985       
## sexF -0.049 -0.023
## optimizer (Nelder_Mead) convergence code: 0 (OK)
## Model failed to converge with max|grad| = 0.00490794 (tol = 0.002, component 1)</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="basic-r.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "sepia",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/iancero/musc_r_course_2021/edit/main/multilevel_models.Rmd",
"text": "Find a typo? Please suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
